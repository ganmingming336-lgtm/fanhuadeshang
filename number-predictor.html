<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>49æ•°å­—å†å²æ•°æ®åˆ†æä¸é¢„æµ‹å·¥å…·ï¼ˆé¿å¼€æœ€è¿‘NæœŸï¼‰</title>
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary: #64748b;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #06b6d4;
            --dark: #1e293b;
            --light: #f8fafc;
            --white: #ffffff;
            --gray-50: #f8fafc;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-300: #cbd5e1;
            --gray-400: #94a3b8;
            --gray-500: #64748b;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-800: #1e293b;
            --gray-900: #0f172a;
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--gray-100);
            color: var(--gray-800);
            line-height: 1.5;
            padding-bottom: 3rem;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        header {
            text-align: center;
            margin-bottom: 2rem;
            padding: 2rem 1rem;
            background: linear-gradient(135deg, #1e293b, #334155);
            color: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
        }

        header h1 {
            font-size: 2.25rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            letter-spacing: -0.025em;
        }

        header p {
            font-size: 1.05rem;
            opacity: 0.9;
            max-width: 840px;
            margin: 0 auto;
        }

        .grid {
            display: grid;
            gap: 1.5rem;
        }

        .grid-cols-1 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
        @media (min-width: 768px) {
            .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
            .grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
            .grid-cols-12 { grid-template-columns: repeat(12, minmax(0, 1fr)); }
        }

        /* Tailwind-like small utilities (only what we actually use in this page) */
        .flex { display: flex; }
        .gap-2 { gap: 0.5rem; }
        .gap-4 { gap: 1rem; }
        .gap-8 { gap: 2rem; }
        .col-span-12 { grid-column: span 12 / span 12; }

        @media (min-width: 768px) {
            .md\:grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        }

        @media (min-width: 1024px) {
            .lg\:col-span-5 { grid-column: span 5 / span 5; }
            .lg\:col-span-7 { grid-column: span 7 / span 7; }
            .lg\:grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
        }

        .card {
            background: var(--white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            border: 1px solid var(--gray-200);
            overflow: hidden;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .card-header {
            padding: 1.25rem;
            border-bottom: 1px solid var(--gray-200);
            background-color: var(--gray-50);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.75rem;
        }

        .card-title {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--gray-900);
        }

        .card-body {
            padding: 1.25rem;
            flex: 1;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 0.5rem;
        }

        textarea {
            width: 100%;
            height: 220px;
            padding: 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-md);
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 0.875rem;
            resize: vertical;
            transition: border-color 0.15s ease-in-out;
        }

        textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .input {
            width: 100%;
            padding: 0.625rem 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
        }

        .input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.625rem 1.25rem;
            font-weight: 600;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            font-size: 0.875rem;
            gap: 0.5rem;
            user-select: none;
        }

        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }

        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover { background-color: var(--primary-dark); }
        .btn-secondary { background-color: var(--gray-200); color: var(--gray-700); }
        .btn-secondary:hover { background-color: var(--gray-300); }
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-danger:hover { background-color: #dc2626; }
        .btn-success { background-color: var(--success); color: white; }
        .btn-success:hover { background-color: #059669; }

        .btn-block { width: 100%; }

        .alert {
            padding: 1rem;
            border-radius: var(--radius-md);
            margin-bottom: 1rem;
            font-size: 0.875rem;
        }

        .alert-info { background-color: #e0f2fe; color: #0369a1; border: 1px solid #bae6fd; }
        .alert-warning { background-color: #ffedd5; color: #9a3412; border: 1px solid #fed7aa; }
        .alert-danger { background-color: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }

        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.2rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 700;
            line-height: 1.3;
        }

        .badge-primary { background-color: #dbeafe; color: #1e40af; }
        .badge-success { background-color: #d1fae5; color: #065f46; }
        .badge-warning { background-color: #fef3c7; color: #92400e; }
        .badge-danger { background-color: #fee2e2; color: #991b1b; }
        .badge-info { background-color: #e0f2fe; color: #075985; }
        .badge-secondary { background-color: var(--gray-200); color: var(--gray-700); }

        .help-text {
            font-size: 0.75rem;
            color: var(--gray-500);
            margin-top: 0.25rem;
        }

        .action-row {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .preview-box {
            background: var(--gray-50);
            border: 1px dashed var(--gray-300);
            border-radius: var(--radius-md);
            padding: 0.75rem;
            margin-top: 0.75rem;
        }

        .preview-title {
            font-weight: 700;
            font-size: 0.875rem;
            color: var(--gray-700);
            margin-bottom: 0.5rem;
        }

        .preview-periods {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .preview-period {
            display: flex;
            flex-wrap: wrap;
            gap: 0.35rem;
            align-items: center;
            font-size: 0.75rem;
            color: var(--gray-600);
        }

        .preview-period strong {
            min-width: 5.5rem;
            color: var(--gray-700);
        }

        .number-chip {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 2.2rem;
            height: 1.6rem;
            border-radius: 0.5rem;
            background: var(--white);
            border: 1px solid var(--gray-200);
            font-weight: 700;
            color: var(--gray-800);
            letter-spacing: 0.02em;
        }

        .stats-summary {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1rem;
        }

        @media (min-width: 1024px) {
            .stats-summary {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        .stat-box {
            background: var(--gray-50);
            padding: 1rem;
            border-radius: var(--radius-md);
            text-align: center;
            border: 1px solid var(--gray-200);
        }

        .stat-box-value {
            font-size: 1.4rem;
            font-weight: 800;
            color: var(--gray-900);
        }

        .stat-box-label {
            font-size: 0.75rem;
            color: var(--gray-500);
            text-transform: uppercase;
            font-weight: 700;
        }

        .top-10-grid {
            display: grid;
            grid-template-columns: repeat(1, 1fr);
            gap: 1rem;
        }

        @media (min-width: 768px) {
            .top-10-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 1024px) {
            .top-10-grid {
                grid-template-columns: repeat(5, 1fr);
            }
        }

        .prediction-card {
            position: relative;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg);
            padding: 1rem;
            background: var(--white);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            min-height: 210px;
        }

        .prediction-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .rank-badge {
            position: absolute;
            top: 0.75rem;
            left: 0.75rem;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 0.875rem;
        }

        .prediction-number {
            font-size: 2.25rem;
            font-weight: 900;
            text-align: center;
            margin: 0.5rem 0;
            color: var(--gray-900);
            letter-spacing: 0.05em;
        }

        .prediction-score {
            text-align: center;
            font-size: 0.875rem;
            color: var(--gray-600);
            margin-bottom: 0.5rem;
        }

        .prediction-reason {
            font-size: 0.75rem;
            color: var(--gray-500);
            margin-top: 0.5rem;
            line-height: 1.4;
        }

        .number-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
        }

        @media (min-width: 768px) {
            .number-grid {
                grid-template-columns: repeat(10, 1fr);
            }
        }

        .number-cell {
            position: relative;
            aspect-ratio: 1 / 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-md);
            font-weight: 800;
            border: 1px solid rgba(0, 0, 0, 0.08);
            cursor: default;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
            background: var(--white);
        }

        .number-cell:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
            z-index: 2;
        }

        .number-cell.predicted {
            border: 2px solid var(--success);
            background: var(--white);
        }

        .number-cell.excluded {
            background: var(--gray-200);
            color: var(--gray-400);
            text-decoration: line-through;
        }

        .number-cell.hot {
            box-shadow: inset 0 0 0 2px rgba(245, 158, 11, 0.9);
        }

        .number-cell.cold {
            box-shadow: inset 0 0 0 2px rgba(59, 130, 246, 0.9);
        }

        .tooltip {
            position: absolute;
            bottom: 110%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(15, 23, 42, 0.95);
            color: white;
            font-size: 0.75rem;
            padding: 0.4rem 0.6rem;
            border-radius: 0.4rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.15s ease;
            z-index: 3;
        }

        .number-cell:hover .tooltip {
            opacity: 1;
        }

        .tabs {
            display: flex;
            flex-wrap: wrap;
            border-bottom: 1px solid var(--gray-200);
            margin-bottom: 1rem;
        }

        .tab {
            padding: 0.75rem 1.25rem;
            cursor: pointer;
            font-weight: 700;
            font-size: 0.875rem;
            color: var(--gray-500);
            border-bottom: 2px solid transparent;
            user-select: none;
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .hidden { display: none; }

        .table-responsive {
            overflow-x: auto;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-md);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--gray-200);
            white-space: nowrap;
        }

        th {
            background: var(--gray-50);
            font-weight: 800;
            color: var(--gray-700);
            position: sticky;
            top: 0;
            z-index: 1;
        }

        tr:hover {
            background: var(--gray-50);
        }

        .progress-bar {
            height: 8px;
            background-color: var(--gray-200);
            border-radius: 4px;
            overflow: hidden;
            width: 100px;
            min-height: 2px;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background-color: var(--primary);
        }

        .chart-bar-container {
            height: 250px;
            display: flex;
            align-items: flex-end;
            gap: 0.6rem;
            padding: 1rem;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-md);
            background: var(--gray-50);
            overflow-x: auto;
        }

        .chart-bar-item {
            flex: 0 0 60px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
        }

        .chart-bar {
            width: 100%;
            background: linear-gradient(to top, var(--primary), #60a5fa);
            border-radius: 6px;
            position: relative;
            min-height: 2px;
            transition: opacity 0.2s;
        }

        .chart-bar:hover {
            opacity: 0.85;
        }

        .chart-bar-label {
            font-size: 0.7rem;
            margin-top: 0.5rem;
            font-weight: 700;
            transform: rotate(-45deg);
            white-space: nowrap;
        }

        .chart-bar-value {
            position: absolute;
            top: -1.35rem;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.7rem;
            font-weight: 800;
            color: var(--gray-700);
        }

        .algo-card {
            border: 1px dashed var(--gray-300);
            border-radius: var(--radius-lg);
            padding: 1rem;
            background: var(--white);
        }

        .algo-card h5 {
            font-weight: 800;
            margin-bottom: 0.5rem;
            color: var(--primary);
            font-size: 0.95rem;
        }

        .algo-numbers {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        /* Responsive adjustments */
        @media (max-width: 640px) {
            header h1 { font-size: 1.6rem; }
            .container { padding: 0.75rem; }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>49æ•°å­—å†å²æ•°æ®åˆ†æä¸é¢„æµ‹</h1>
        <p>
            æ”¯æŒç²˜è´´å†å²å¼€å¥–æ•°æ®ï¼ˆ1-49ï¼‰ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨è¯†åˆ«æœŸæ•°å¹¶è¿›è¡Œç»Ÿè®¡åˆ†æã€‚é¢„æµ‹é˜¶æ®µä¼š<strong>è‡ªåŠ¨é¿å¼€æœ€è¿‘ N æœŸå‡ºç°è¿‡çš„æ‰€æœ‰æ•°å­—</strong>ï¼Œ
            å†ä»å‰©ä½™æ•°å­—ä¸­ï¼ŒåŸºäº 5 ç§ç®—æ³•ç»¼åˆæ¨ç®—ä¸‹ä¸€æœŸæ¦‚ç‡æœ€é«˜çš„ Top Kã€‚
        </p>
    </header>

    <div class="grid grid-cols-12">
        <!-- Input Section -->
        <div class="col-span-12 lg:col-span-5">
            <div class="card">
                <div class="card-header">
                    <span class="card-title">æ•°æ®å½•å…¥</span>
                    <button id="btnLoadExample" class="btn btn-secondary btn-sm">åŠ è½½ç¤ºä¾‹</button>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label for="historyInput">ç²˜è´´å†å²ä¸­å¥–å·ç ï¼ˆ1-49ï¼‰</label>
                        <textarea id="historyInput" placeholder="æ”¯æŒå¤šç§æ ¼å¼ï¼š
1, 2, 3, 4, 5, 6
01 02 03 04 05 06
æ¯è¡Œä»£è¡¨ä¸€æœŸï¼ˆæ¨èï¼‰ã€‚ä¹Ÿæ”¯æŒæŠŠæ‰€æœ‰æ•°å­—ç²˜åˆ°ä¸€è¡Œï¼Œç³»ç»Ÿä¼šå°½é‡è‡ªåŠ¨åˆ†æœŸã€‚"></textarea>
                        <p class="help-text">æ”¯æŒç©ºæ ¼ã€é€—å·ã€æ¢è¡Œã€ä¸­æ–‡é€—å·ã€é¡¿å·ç­‰åˆ†éš”ã€‚é»˜è®¤è®¤ä¸º<strong>æœ€åä¸€è¡Œï¼ˆæˆ–æœ€åä¸€ç»„ï¼‰æ˜¯æœ€æ–°ä¸€æœŸ</strong>ã€‚</p>
                    </div>

                    <div id="inputWarning" class="alert alert-warning hidden"></div>
                    <div id="inputError" class="alert alert-danger hidden"></div>

                    <div class="preview-box">
                        <div class="preview-title">æ•°æ®é¢„è§ˆï¼ˆå®æ—¶è¯†åˆ«ï¼‰</div>
                        <div id="previewSummary" class="help-text">å°šæœªè¯†åˆ«åˆ°æœ‰æ•ˆæ•°æ®</div>
                        <div id="previewPeriods" class="preview-periods"></div>
                    </div>

                    <div class="grid grid-cols-2 gap-4" style="margin-top: 1rem;">
                        <div class="form-group">
                            <label for="excludePeriods">é¿å¼€æœ€è¿‘å‡ æœŸå‡ºç°è¿‡çš„æ•°å­—</label>
                            <input type="number" id="excludePeriods" class="input" value="7" min="0" max="30">
                            <p class="help-text">é»˜è®¤é¿å¼€æœ€è¿‘ 7 æœŸï¼ˆå¯è‡ªè¡Œè°ƒæ•´ï¼‰</p>
                        </div>
                        <div class="form-group">
                            <label for="predictCount">æ¨é€‰æ•°å­—ä¸ªæ•°ï¼ˆTop Kï¼‰</label>
                            <input type="number" id="predictCount" class="input" value="10" min="1" max="20">
                            <p class="help-text">é»˜è®¤ Top 10ï¼ˆä»…ä»æœªæ’é™¤æ•°å­—ä¸­é€‰æ‹©ï¼‰</p>
                        </div>
                    </div>

                    <div class="action-row">
                        <button id="btnAnalyze" class="btn btn-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M6 1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h3zM3 2v3h3V2H3zm6-1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1H9a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h3zm0 1v3h3V2H9zM5 8a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V9a1 1 0 0 1 1-1h2zm-2 1v3h3V9H3zm10-1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-3a1 1 0 0 1-1-1V9a1 1 0 0 1 1-1h3zm-3 1v3h3V9h-3z"/></svg>
                            ç«‹å³åˆ†æé¢„æµ‹
                        </button>
                        <button id="btnClear" class="btn btn-secondary">æ¸…ç©º</button>
                    </div>

                    <p class="help-text" style="margin-top: 0.75rem;">
                        å¿«æ·é”®ï¼š<strong>Ctrl + Enter</strong> ç«‹å³åˆ†æã€‚
                    </p>
                </div>
            </div>
        </div>

        <!-- Result Overview Section -->
        <div class="col-span-12 lg:col-span-7">
            <div id="welcomeMessage" class="card">
                <div class="card-body" style="display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; min-height: 420px;">
                    <div style="font-size: 4rem; margin-bottom: 1rem; opacity: 0.2;">ğŸ“Š</div>
                    <h2 class="card-title" style="font-size: 1.5rem; margin-bottom: 0.5rem;">å‡†å¤‡å°±ç»ª</h2>
                    <p style="color: var(--gray-500); max-width: 520px;">
                        åœ¨å·¦ä¾§ç²˜è´´å†å²æ•°æ®åç‚¹å‡»â€œç«‹å³åˆ†æé¢„æµ‹â€ã€‚å·¥å…·ä¼šè¾“å‡º Top K æ¨èã€é¿å¼€æ•°å­—è¯´æ˜ã€å…¨å±€çƒ­åŠ›å›¾ã€è¯¦ç»†ç»Ÿè®¡è¡¨ã€
                        ä»¥åŠå¤šç®—æ³•å¯¹æ¯”ã€‚
                    </p>
                </div>
            </div>

            <div id="resultsContainer" class="hidden">
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">åˆ†æç»“æœæ¦‚è§ˆ</span>
                        <div class="flex gap-2" style="align-items: center;">
                            <div id="analysisTime" class="badge badge-info"></div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="stats-summary">
                            <div class="stat-box">
                                <div id="statTotalPeriods" class="stat-box-value">0</div>
                                <div class="stat-box-label">æ€»æœŸæ•°</div>
                            </div>
                            <div class="stat-box">
                                <div id="statTotalNumbers" class="stat-box-value">0</div>
                                <div class="stat-box-label">æœ‰æ•ˆæ•°å­—</div>
                            </div>
                            <div class="stat-box">
                                <div id="statExcludedCount" class="stat-box-value">0</div>
                                <div class="stat-box-label">æ’é™¤æ•°å­—</div>
                            </div>
                            <div class="stat-box">
                                <div id="statAvgCount" class="stat-box-value">0</div>
                                <div class="stat-box-label">å¹³å‡å‡ºç°æ¬¡æ•°</div>
                            </div>
                        </div>

                        <div id="excludedNumbersSection" class="alert alert-warning">
                            <strong>å·²é¿å¼€æœ€å <span id="displayExcludeN">7</span> æœŸæ•°å­—ï¼š</strong>
                            <div id="excludedList" style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;"></div>
                            <div class="help-text" style="margin-top: 0.5rem;">
                                é¿å¼€åŸå› ï¼šè¿‘æœŸåˆšå‡ºç°è¿‡çš„æ•°å­—çŸ­æœŸå†…é‡å¤å‡ºç°çš„æ¦‚ç‡é€šå¸¸è¾ƒä½ï¼ˆç­–ç•¥æ€§è¿‡æ»¤ï¼Œéæ•°å­¦å®šå¾‹ï¼‰ã€‚
                            </div>
                        </div>

                        <h3 class="card-title" style="margin: 1.5rem 0 1rem;">ğŸ† Top <span id="displayPredictK">10</span> æ¨èï¼ˆå·²æ’é™¤æœ€è¿‘NæœŸï¼‰</h3>
                        <div id="topResults" class="top-10-grid"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Details Section -->
        <div class="col-span-12">
            <div id="detailsContainer" class="card hidden" style="margin-top: 1.5rem;">
                <div class="card-header">
                    <div class="tabs" style="margin-bottom: 0;">
                        <div class="tab active" data-tab="tab-heatmap">å…¨å±€çƒ­åŠ›å›¾</div>
                        <div class="tab" data-tab="tab-stats">è¯¦ç»†ç»Ÿè®¡è¡¨</div>
                        <div class="tab" data-tab="tab-charts">å¯è§†åŒ–å›¾è¡¨</div>
                        <div class="tab" data-tab="tab-algorithms">ç®—æ³•å¯¹æ¯”</div>
                        <div class="tab" data-tab="tab-history">å†å²è®°å½•</div>
                    </div>
                    <div class="flex gap-2" style="flex-wrap: wrap; justify-content: flex-end;">
                        <button id="btnExportJSON" class="btn btn-secondary btn-sm">å¯¼å‡º JSON</button>
                        <button id="btnExportCSV" class="btn btn-secondary btn-sm">å¯¼å‡º CSV</button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Global Heatmap -->
                    <div id="tab-heatmap" class="tab-content active">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div>
                                <h4 class="card-title" style="font-size: 1rem; margin-bottom: 1rem;">49æ•°å­—çƒ­å†·åˆ†å¸ƒï¼ˆé¢œè‰²è¶Šæ·±å‡ºç°è¶Šé¢‘ç¹ï¼‰</h4>
                                <div id="heatmapGrid" class="number-grid"></div>
                                <div style="display: flex; justify-content: space-between; margin-top: 1rem; font-size: 0.75rem; color: var(--gray-500);">
                                    <span>å†·</span>
                                    <div style="flex: 1; margin: 0 1rem; height: 10px; background: linear-gradient(to right, #f1f5f9, var(--primary)); border-radius: 5px;"></div>
                                    <span>çƒ­</span>
                                </div>
                            </div>
                            <div style="background: var(--gray-50); padding: 1.5rem; border-radius: var(--radius-md); border: 1px solid var(--gray-200);">
                                <h4 class="card-title" style="font-size: 1rem; margin-bottom: 1rem;">å›¾ä¾‹è¯´æ˜</h4>
                                <ul style="list-style: none; font-size: 0.875rem; color: var(--gray-600);">
                                    <li style="display: flex; align-items: center; margin-bottom: 0.5rem;">
                                        <div style="width: 20px; height: 20px; background: var(--white); border: 2px solid var(--success); border-radius: 4px; margin-right: 10px;"></div>
                                        <span>é¢„æµ‹æ¨é€‰çš„æ•°å­—ï¼ˆTop Kï¼‰</span>
                                    </li>
                                    <li style="display: flex; align-items: center; margin-bottom: 0.5rem;">
                                        <div style="width: 20px; height: 20px; background: var(--gray-200); border: 1px solid var(--gray-300); border-radius: 4px; margin-right: 10px;"></div>
                                        <span>é¿å¼€çš„æ•°å­—ï¼ˆæœ€è¿‘ N æœŸå‡ºç°è¿‡ï¼‰</span>
                                    </li>
                                    <li style="display: flex; align-items: center; margin-bottom: 0.5rem;">
                                        <div style="width: 20px; height: 20px; background: var(--white); border: 2px solid rgba(245, 158, 11, 0.9); border-radius: 4px; margin-right: 10px;"></div>
                                        <span>çƒ­å·ï¼ˆå‡ºç°æ¬¡æ•°æ˜æ˜¾é«˜äºå¹³å‡ï¼‰</span>
                                    </li>
                                    <li style="display: flex; align-items: center; margin-bottom: 0.5rem;">
                                        <div style="width: 20px; height: 20px; background: var(--white); border: 2px solid rgba(59, 130, 246, 0.9); border-radius: 4px; margin-right: 10px;"></div>
                                        <span>å†·å·ï¼ˆå‡ºç°æ¬¡æ•°æ˜æ˜¾ä½äºå¹³å‡ï¼‰</span>
                                    </li>
                                </ul>
                                <div style="margin-top: 1.25rem; padding-top: 1rem; border-top: 1px solid var(--gray-200);">
                                    <p style="font-size: 0.875rem; color: var(--gray-500);">
                                        <strong>åˆ†ææµç¨‹ï¼š</strong> å…ˆç»Ÿè®¡æ¯ä¸ªæ•°å­—çš„å‡ºç°æ¬¡æ•°ã€é—æ¼æœŸæ•°ã€å¹³å‡é—´éš”ã€å¡æ–¹åå·®ï¼›
                                        å†æ ¹æ®ç»¼åˆè¯„åˆ†é€‰å‡º Top Kï¼Œå¹¶æ ¹æ®â€œé¿å¼€æœ€è¿‘ N æœŸâ€ç­–ç•¥å‰”é™¤è¿‘æœŸå·²å‡ºç°æ•°å­—ã€‚
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Statistics Table -->
                    <div id="tab-stats" class="tab-content">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4" style="margin-bottom: 1rem;">
                            <div class="algo-card" style="border-style: solid;">
                                <h5 style="margin: 0; color: var(--gray-900); font-size: 1rem;">æœ€å¸¸å‡ºç° Top 10</h5>
                                <div id="mostFrequentList" class="algo-numbers"></div>
                            </div>
                            <div class="algo-card" style="border-style: solid;">
                                <h5 style="margin: 0; color: var(--gray-900); font-size: 1rem;">æœ€å°‘å‡ºç° Top 10</h5>
                                <div id="leastFrequentList" class="algo-numbers"></div>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table id="statsTable">
                                <thead>
                                    <tr>
                                        <th>æ•°å­—</th>
                                        <th>å‡ºç°æ¬¡æ•°</th>
                                        <th>é¢‘ç‡ (%)</th>
                                        <th>æœ€åå‡ºç° (æœŸ)</th>
                                        <th>å¹³å‡é—´éš”</th>
                                        <th>é¢‘ç‡åˆ†</th>
                                        <th>å†·å·åˆ†</th>
                                        <th>å‘¨æœŸåˆ†</th>
                                        <th>ç»¼åˆåˆ†</th>
                                        <th>å¡æ–¹åˆ†</th>
                                        <th>æœ€ç»ˆåˆ†</th>
                                        <th>çŠ¶æ€</th>
                                    </tr>
                                </thead>
                                <tbody id="statsTableBody"></tbody>
                            </table>
                        </div>
                        <p class="help-text" style="margin-top: 0.75rem;">
                            è¯´æ˜ï¼šé¢‘ç‡åˆ†=å‡ºç°æ¬¡æ•°å½’ä¸€åŒ–ï¼›å†·å·åˆ†=é—æ¼æœŸæ•°å½’ä¸€åŒ–ï¼›å‘¨æœŸåˆ†=å½“å‰é—´éš”ä¸å¹³å‡é—´éš”è¶Šæ¥è¿‘è¶Šé«˜ï¼›ç»¼åˆåˆ†=é¢‘ç‡/å†·å·/å‘¨æœŸåŠ æƒï¼›å¡æ–¹åˆ†=åç¦»å‡åŒ€åˆ†å¸ƒç¨‹åº¦ï¼›æœ€ç»ˆåˆ†=ç»¼åˆåˆ†ä¸å¡æ–¹åˆ†åŠ æƒã€‚
                        </p>
                    </div>

                    <!-- Charts -->
                    <div id="tab-charts" class="tab-content">
                        <h4 class="card-title" style="font-size: 1rem; margin-bottom: 1.25rem;">Top K æ¨èæ•°å­—çš„â€œæœ€ç»ˆåˆ†â€æŸ±çŠ¶å›¾</h4>
                        <div id="topChart" class="chart-bar-container"></div>
                    </div>

                    <!-- Algorithms -->
                    <div id="tab-algorithms" class="tab-content">
                        <h4 class="card-title" style="font-size: 1rem; margin-bottom: 1rem;">ä¸åŒç®—æ³• Top <span id="displayPredictK2">10</span> å¯¹æ¯”ï¼ˆåŒæ ·å·²æ’é™¤æœ€è¿‘ N æœŸï¼‰</h4>
                        <div id="algorithmCompareGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>

                        <div style="margin-top: 1.5rem;">
                            <h4 class="card-title" style="font-size: 1rem; margin-bottom: 1rem;">ç®—æ³•è¯´æ˜ï¼ˆ5ç§ï¼‰</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <div class="algo-card">
                                    <h5>1. é¢‘ç‡åˆ†æï¼ˆFrequencyï¼‰</h5>
                                    <p style="font-size: 0.875rem; color: var(--gray-600);">ç»Ÿè®¡æ¯ä¸ªæ•°å­—åœ¨å…¨éƒ¨å†å²æ•°æ®ä¸­çš„å‡ºç°æ¬¡æ•°ã€‚å‡ºç°è¶Šå¤šï¼Œé¢‘ç‡åˆ†è¶Šé«˜ã€‚</p>
                                </div>
                                <div class="algo-card">
                                    <h5>2. å†·å·åå¼¹ï¼ˆCold Reboundï¼‰</h5>
                                    <p style="font-size: 0.875rem; color: var(--gray-600);">è®¡ç®—è·ç¦»ä¸Šæ¬¡å‡ºç°å·²è¿‡å»å¤šå°‘æœŸã€‚é—æ¼è¶Šä¹…ï¼Œå†·å·åˆ†è¶Šé«˜ï¼ˆåå¼¹æ½œåŠ›ï¼‰ã€‚</p>
                                </div>
                                <div class="algo-card">
                                    <h5>3. æ—¶é—´é—´éš”ï¼ˆPeriodicityï¼‰</h5>
                                    <p style="font-size: 0.875rem; color: var(--gray-600);">è®¡ç®—å¹³å‡é—´éš”ã€‚å½“å½“å‰é—æ¼æœŸæ•°æ¥è¿‘å¹³å‡é—´éš”æ—¶ï¼Œå‘¨æœŸåˆ†æ›´é«˜ã€‚</p>
                                </div>
                                <div class="algo-card">
                                    <h5>4. ç»¼åˆè¯„åˆ†ï¼ˆComprehensiveï¼‰</h5>
                                    <p style="font-size: 0.875rem; color: var(--gray-600);">ç»¼åˆåˆ†=é¢‘ç‡åˆ†ã€å†·å·åˆ†ã€å‘¨æœŸåˆ†çš„åŠ æƒå¹³å‡ï¼ˆå¼ºè°ƒå¹³è¡¡ä¸ç¨³å®šæ€§ï¼‰ã€‚</p>
                                </div>
                                <div class="algo-card">
                                    <h5>5. å¡æ–¹åå·®ï¼ˆChi-Squareï¼‰</h5>
                                    <p style="font-size: 0.875rem; color: var(--gray-600);">è¡¡é‡æ•°å­—å‡ºç°æ¬¡æ•°ç›¸å¯¹å‡åŒ€åˆ†å¸ƒçš„åç¦»ç¨‹åº¦ï¼Œç”¨äºæ•æ‰ç»Ÿè®¡å¼‚å¸¸è¶‹åŠ¿ï¼ˆä»…ä½œå‚è€ƒï¼‰ã€‚</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- History -->
                    <div id="tab-history" class="tab-content">
                        <div class="action-row" style="justify-content: space-between; align-items: center;">
                            <div style="font-size: 0.875rem; color: var(--gray-600);">
                                å·²ä¿å­˜ <strong id="historyCount">0</strong> æ¡åˆ†æè®°å½•ï¼ˆä»…ä¿ç•™æœ€è¿‘ 30 æ¡ï¼‰
                            </div>
                            <div class="flex gap-2" style="flex-wrap: wrap;">
                                <button id="btnClearHistory" class="btn btn-danger btn-sm">æ¸…ç©ºå†å²</button>
                            </div>
                        </div>
                        <div class="table-responsive" style="margin-top: 1rem;">
                            <table id="historyTable">
                                <thead>
                                    <tr>
                                        <th>æ—¶é—´</th>
                                        <th>æœŸæ•°</th>
                                        <th>é¿å¼€NæœŸ</th>
                                        <th>TopK</th>
                                        <th>æ’é™¤æ•°</th>
                                        <th>TopKç»“æœ</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="historyTableBody"></tbody>
                            </table>
                        </div>
                        <p class="help-text" style="margin-top: 0.75rem;">
                            ç‚¹å‡»â€œåŠ è½½â€ä¼šå°†è¯¥æ¬¡åˆ†æçš„åŸå§‹æ•°æ®ä¸å‚æ•°è½½å…¥è¾“å…¥æ¡†å¹¶é‡æ–°è®¡ç®—ï¼Œæ–¹ä¾¿ä½ å¯¹æ¯”ä¸åŒæ—¶åˆ»çš„é¢„æµ‹ç»“æœã€‚
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer style="margin-top: 3rem; text-align: center; color: var(--gray-500); font-size: 0.875rem;">
        <p>Â© 2024-2025 49æ•°å­—å†å²æ•°æ®åˆ†æä¸é¢„æµ‹å·¥å…· - ä»…ä¾›å­¦ä¹ å‚è€ƒ</p>
    </footer>
</div>

<script>
    const STORAGE_KEY_CURRENT = 'numberPredictorCurrent_v2';
    const STORAGE_KEY_CURRENT_LEGACY = 'numberPredictorData_v1';
    const STORAGE_KEY_HISTORY = 'numberPredictorHistory_v1';
    const HISTORY_LIMIT = 30;

    const state = {
        rawData: '',
        processedData: [],
        flatData: [],
        stats: {},
        predictions: [],
        excludedNumbers: [],
        algorithmResults: null,
        diagnostics: null,
        settings: {
            excludeN: 7,
            predictCount: 10
        },
        history: []
    };

    const elements = {
        historyInput: document.getElementById('historyInput'),
        excludePeriods: document.getElementById('excludePeriods'),
        predictCount: document.getElementById('predictCount'),
        btnAnalyze: document.getElementById('btnAnalyze'),
        btnClear: document.getElementById('btnClear'),
        btnLoadExample: document.getElementById('btnLoadExample'),
        inputWarning: document.getElementById('inputWarning'),
        inputError: document.getElementById('inputError'),
        previewSummary: document.getElementById('previewSummary'),
        previewPeriods: document.getElementById('previewPeriods'),
        welcomeMessage: document.getElementById('welcomeMessage'),
        resultsContainer: document.getElementById('resultsContainer'),
        detailsContainer: document.getElementById('detailsContainer'),
        statTotalPeriods: document.getElementById('statTotalPeriods'),
        statTotalNumbers: document.getElementById('statTotalNumbers'),
        statExcludedCount: document.getElementById('statExcludedCount'),
        statAvgCount: document.getElementById('statAvgCount'),
        analysisTime: document.getElementById('analysisTime'),
        displayExcludeN: document.getElementById('displayExcludeN'),
        displayPredictK: document.getElementById('displayPredictK'),
        displayPredictK2: document.getElementById('displayPredictK2'),
        excludedList: document.getElementById('excludedList'),
        topResults: document.getElementById('topResults'),
        heatmapGrid: document.getElementById('heatmapGrid'),
        mostFrequentList: document.getElementById('mostFrequentList'),
        leastFrequentList: document.getElementById('leastFrequentList'),
        statsTableBody: document.getElementById('statsTableBody'),
        topChart: document.getElementById('topChart'),
        algorithmCompareGrid: document.getElementById('algorithmCompareGrid'),
        historyCount: document.getElementById('historyCount'),
        historyTableBody: document.getElementById('historyTableBody'),
        btnClearHistory: document.getElementById('btnClearHistory'),
        btnExportJSON: document.getElementById('btnExportJSON'),
        btnExportCSV: document.getElementById('btnExportCSV'),
        tabs: document.querySelectorAll('.tab'),
        tabContents: document.querySelectorAll('.tab-content')
    };

    function debounce(fn, delay) {
        let timer = null;
        return (...args) => {
            clearTimeout(timer);
            timer = setTimeout(() => fn(...args), delay);
        };
    }

    function clamp(n, min, max) {
        return Math.min(max, Math.max(min, n));
    }

    function pad2(n) {
        return n.toString().padStart(2, '0');
    }

    function downloadBlob(blob, filename) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        setTimeout(() => URL.revokeObjectURL(url), 1500);
    }

    function simpleHash(str) {
        // DJB2-like
        let hash = 5381;
        for (let i = 0; i < str.length; i++) {
            hash = ((hash << 5) + hash) + str.charCodeAt(i);
            hash = hash & 0xffffffff;
        }
        return (hash >>> 0).toString(16);
    }

    function parseInputWithDiagnostics(input) {
        const diagnostics = {
            hasNonStandardChars: /[^0-9\s,ï¼Œã€;ï¼›|\n\r\t]/.test(input),
            extractedCount: 0,
            validCount: 0,
            outOfRangeCount: 0,
            duplicateInPeriodCount: 0,
            emptyLineCount: 0,
            periodsDetected: 0,
            periodSizeHint: null,
            parseMode: 'æŒ‰è¡Œè¯†åˆ«',
            warnings: []
        };

        const normalizedInput = input.replace(/\r/g, '');
        const lines = normalizedInput.split('\n');

        // å…ˆæŒ‰â€œè¡Œâ€æå–æ•°å­—åºåˆ—ï¼ˆä¿ç•™é¡ºåºä¸é‡å¤ï¼‰ï¼Œåç»­å†æ ¹æ®è§„åˆ™â€œåˆ†æœŸâ€ï¼Œå†å¯¹æ¯æœŸå»é‡
        const rawLineNumberGroups = [];

        for (const lineRaw of lines) {
            const line = lineRaw.trim();
            if (!line) {
                diagnostics.emptyLineCount++;
                continue;
            }

            const tokens = line.match(/\d+/g) || [];
            diagnostics.extractedCount += tokens.length;

            const nums = [];
            for (const t of tokens) {
                const n = parseInt(t, 10);
                if (Number.isNaN(n)) continue;
                if (n >= 1 && n <= 49) nums.push(n);
                else diagnostics.outOfRangeCount++;
            }

            if (nums.length > 0) rawLineNumberGroups.push(nums);
        }

        function mode(arr) {
            const counts = new Map();
            for (const v of arr) counts.set(v, (counts.get(v) || 0) + 1);
            let best = null;
            let bestCount = 0;
            for (const [k, c] of counts.entries()) {
                if (c > bestCount || (c === bestCount && k > best)) {
                    best = k;
                    bestCount = c;
                }
            }
            return { value: best, count: bestCount };
        }

        // åˆ†æœŸï¼ˆå€™é€‰æœŸï¼Œå°šæœªå»é‡ï¼‰
        let periodCandidates = [];

        if (rawLineNumberGroups.length > 1) {
            const lengths = rawLineNumberGroups.map(p => p.length).filter(len => len > 0);
            const { value: modeLen, count: modeCount } = mode(lengths);

            const useChunking = modeLen && modeLen >= 5 && modeLen <= 20 && modeCount >= 2;
            if (useChunking) {
                diagnostics.periodSizeHint = modeLen;
                for (const group of rawLineNumberGroups) {
                    if (group.length > modeLen && group.length % modeLen === 0) {
                        for (let i = 0; i < group.length; i += modeLen) {
                            periodCandidates.push(group.slice(i, i + modeLen));
                        }
                        diagnostics.parseMode = `æŒ‰è¡Œè¯†åˆ« + è‡ªåŠ¨åˆ‡åˆ†ï¼ˆæ¯æœŸçº¦ ${modeLen} ä¸ªï¼‰`;
                    } else {
                        periodCandidates.push(group);
                    }
                }
            } else {
                periodCandidates = rawLineNumberGroups;
            }
        } else if (rawLineNumberGroups.length === 1) {
            const only = rawLineNumberGroups[0];
            periodCandidates = [only];

            // å¦‚æœåªæœ‰ä¸€è¡Œä½†æ•°å­—å¾ˆå¤šï¼Œå°è¯•è‡ªåŠ¨åˆ†æœŸï¼ˆä¼˜å…ˆ 7ï¼Œå…¶æ¬¡ 6ï¼‰
            if (only.length >= 12) {
                const trySizes = [7, 6];
                const size = trySizes.find(s => only.length % s === 0 && only.length / s >= 2);
                if (size) {
                    periodCandidates = [];
                    for (let i = 0; i < only.length; i += size) {
                        periodCandidates.push(only.slice(i, i + size));
                    }
                    diagnostics.parseMode = `è‡ªåŠ¨åˆ†æœŸï¼ˆæ¯æœŸ ${size} ä¸ªï¼‰`;
                    diagnostics.periodSizeHint = size;
                } else {
                    diagnostics.warnings.push('æ£€æµ‹åˆ°å•è¡Œè¾“å…¥ä¸”æ•°å­—è¾ƒå¤šï¼Œä½†æ— æ³•ç¨³å®šåˆ†æœŸï¼šå»ºè®®æ¯è¡Œä»£è¡¨ä¸€æœŸï¼Œä»¥è·å¾—æ›´å‡†ç¡®çš„â€œé¿å¼€æœ€è¿‘NæœŸ/é—´éš”â€ç»“æœã€‚');
                }
            }
        }

        // æ¯æœŸå»é‡ï¼ˆä¿æŒåˆ†æç¨³å®šæ€§ï¼Œé¿å…â€œåŒä¸€æœŸé‡å¤æ•°å­—â€å¹²æ‰°ï¼‰
        const periods = [];
        for (const cand of periodCandidates) {
            const seen = new Set();
            const unique = [];
            let dup = 0;
            for (const n of cand) {
                if (seen.has(n)) {
                    dup++;
                    continue;
                }
                seen.add(n);
                unique.push(n);
            }
            diagnostics.duplicateInPeriodCount += dup;

            const sorted = unique.sort((a, b) => a - b);
            if (sorted.length > 0) periods.push(sorted);
        }

        const allNumbers = periods.flat();
        diagnostics.validCount = allNumbers.length;
        diagnostics.periodsDetected = periods.length;

        // è¡¥å……æç¤º
        if (diagnostics.hasNonStandardChars) diagnostics.warnings.push('å‘ç°éæ•°å­—å­—ç¬¦ï¼ˆå°†è¢«å¿½ç•¥ï¼‰ã€‚');
        if (diagnostics.outOfRangeCount > 0) diagnostics.warnings.push(`å‘ç° ${diagnostics.outOfRangeCount} ä¸ªè¶…å‡º 1-49 çš„æ•°å­—ï¼ˆå·²å¿½ç•¥ï¼‰ã€‚`);
        if (diagnostics.duplicateInPeriodCount > 0) diagnostics.warnings.push(`å‘ç° ${diagnostics.duplicateInPeriodCount} ä¸ªâ€œåŒä¸€æœŸå†…é‡å¤æ•°å­—â€ï¼ˆå·²è‡ªåŠ¨å»é‡ï¼‰ã€‚`);

        return { periods, allNumbers, diagnostics };
    }

    function calculateStats(periods, allNumbers) {
        const totalPeriods = periods.length;
        const totalNumCount = allNumbers.length;

        const stats = {};
        for (let i = 1; i <= 49; i++) {
            stats[i] = {
                num: i,
                count: 0,
                freq: 0,
                lastSeen: totalPeriods, // default as never seen
                gaps: [],
                avgGap: totalPeriods,
                chiSquare: 0,
                flags: {
                    hot: false,
                    cold: false
                },
                scores: {
                    freq: 0,
                    gap: 0,
                    period: 0,
                    comprehensive: 0,
                    chi: 0
                },
                totalScore: 0
            };
        }

        for (const n of allNumbers) {
            if (stats[n]) stats[n].count++;
        }

        // build period sets for O(1) contains
        const periodSets = periods.map(p => new Set(p));

        for (let i = 1; i <= 49; i++) {
            const s = stats[i];
            s.freq = totalNumCount > 0 ? (s.count / totalNumCount) * 100 : 0;

            // last seen from newest backward
            let foundAt = -1;
            for (let j = totalPeriods - 1; j >= 0; j--) {
                if (periodSets[j].has(i)) {
                    foundAt = j;
                    break;
                }
            }
            s.lastSeen = foundAt !== -1 ? (totalPeriods - 1) - foundAt : totalPeriods;

            // gaps
            let lastIdx = -1;
            for (let pIdx = 0; pIdx < totalPeriods; pIdx++) {
                if (periodSets[pIdx].has(i)) {
                    if (lastIdx !== -1) {
                        s.gaps.push(pIdx - lastIdx);
                    }
                    lastIdx = pIdx;
                }
            }

            if (s.gaps.length > 0) {
                s.avgGap = s.gaps.reduce((a, b) => a + b, 0) / s.gaps.length;
            } else {
                s.avgGap = totalPeriods;
            }
        }

        // chi-square component
        const expected = totalNumCount > 0 ? totalNumCount / 49 : 0;
        for (let i = 1; i <= 49; i++) {
            const s = stats[i];
            s.chiSquare = expected > 0 ? Math.pow(s.count - expected, 2) / expected : 0;
        }

        const values = Object.values(stats);
        const maxCount = Math.max(...values.map(v => v.count), 0);
        const maxLastSeen = Math.max(...values.map(v => v.lastSeen), 0);
        const maxChi = Math.max(...values.map(v => v.chiSquare), 0);
        const avgCount = expected;

        for (const s of values) {
            s.flags.hot = avgCount > 0 ? s.count >= avgCount * 1.2 : false;
            s.flags.cold = avgCount > 0 ? s.count <= avgCount * 0.6 : false;

            s.scores.freq = maxCount > 0 ? (s.count / maxCount) * 100 : 0;
            s.scores.gap = maxLastSeen > 0 ? (s.lastSeen / maxLastSeen) * 100 : 0;

            if (s.avgGap > 0) {
                const diff = Math.abs(s.lastSeen - s.avgGap);
                s.scores.period = clamp(100 - (diff / s.avgGap) * 100, 0, 100);
            } else {
                s.scores.period = 0;
            }

            s.scores.comprehensive = (s.scores.freq * 0.4) + (s.scores.gap * 0.35) + (s.scores.period * 0.25);
            s.scores.chi = maxChi > 0 ? (s.chiSquare / maxChi) * 100 : 0;

            // final score: comprehensive + chi-square
            s.totalScore = (s.scores.comprehensive * 0.75) + (s.scores.chi * 0.25);
        }

        return { stats, expectedAvgCount: avgCount };
    }

    function getExcludedNumbers(periods, excludeN) {
        const total = periods.length;
        const n = clamp(excludeN, 0, total);
        const set = new Set();

        for (let i = total - 1; i >= Math.max(0, total - n); i--) {
            for (const num of periods[i]) set.add(num);
        }

        return Array.from(set).sort((a, b) => a - b);
    }

    function getTopK(statsObj, excludedSet, k, scoreGetter) {
        return Object.values(statsObj)
            .filter(s => !excludedSet.has(s.num))
            .sort((a, b) => scoreGetter(b) - scoreGetter(a))
            .slice(0, k);
    }

    function buildAlgorithmResults(statsObj, excludedNumbers, k) {
        const excludedSet = new Set(excludedNumbers);
        const by = (getter) => getTopK(statsObj, excludedSet, k, getter).map(s => s.num);

        const freq = by(s => s.scores.freq);
        const gap = by(s => s.scores.gap);
        const period = by(s => s.scores.period);
        const comprehensive = by(s => s.scores.comprehensive);
        const chi = by(s => s.scores.chi);
        const final = by(s => s.totalScore);

        return {
            freq,
            gap,
            period,
            comprehensive,
            chi,
            final
        };
    }

    function showError(msg) {
        elements.inputError.textContent = msg;
        elements.inputError.classList.remove('hidden');
    }

    function clearError() {
        elements.inputError.textContent = '';
        elements.inputError.classList.add('hidden');
    }

    function showWarnings(diagnostics) {
        const warns = diagnostics?.warnings || [];
        if (warns.length === 0) {
            elements.inputWarning.textContent = '';
            elements.inputWarning.classList.add('hidden');
            return;
        }
        elements.inputWarning.innerHTML = `<strong>æç¤ºï¼š</strong> ${warns.join(' ')}<div class="help-text" style="margin-top: 0.5rem;">è§£ææ¨¡å¼ï¼š${diagnostics.parseMode}</div>`;
        elements.inputWarning.classList.remove('hidden');
    }

    function renderPreview() {
        const input = elements.historyInput.value.trim();
        if (!input) {
            elements.previewSummary.textContent = 'å°šæœªè¯†åˆ«åˆ°æœ‰æ•ˆæ•°æ®';
            elements.previewPeriods.innerHTML = '';
            elements.inputWarning.classList.add('hidden');
            clearError();
            return;
        }

        const { periods, allNumbers, diagnostics } = parseInputWithDiagnostics(input);

        if (periods.length === 0) {
            elements.previewSummary.textContent = 'æœªè¯†åˆ«åˆ°æœ‰æ•ˆçš„ 1-49 æ•°å­—';
            elements.previewPeriods.innerHTML = '';
            showWarnings(diagnostics);
            return;
        }

        showWarnings(diagnostics);
        clearError();

        const avgPerPeriod = (allNumbers.length / periods.length).toFixed(2);
        elements.previewSummary.textContent = `å·²è¯†åˆ« ${periods.length} æœŸï¼Œå…± ${allNumbers.length} ä¸ªæœ‰æ•ˆæ•°å­—ï¼ˆå¹³å‡æ¯æœŸ ${avgPerPeriod} ä¸ªï¼‰ã€‚`;

        const show = [];
        const maxShow = 3;
        for (let i = Math.max(0, periods.length - maxShow); i < periods.length; i++) {
            show.push({ idx: i, nums: periods[i] });
        }

        elements.previewPeriods.innerHTML = '';
        show.forEach((p, index) => {
            const div = document.createElement('div');
            div.className = 'preview-period';

            const label = document.createElement('strong');
            label.textContent = index === show.length - 1 ? `æœ€æ–°ä¸€æœŸï¼š` : `ç¬¬ ${p.idx + 1} æœŸï¼š`;
            div.appendChild(label);

            p.nums.forEach(n => {
                const chip = document.createElement('span');
                chip.className = 'number-chip';
                chip.textContent = pad2(n);
                div.appendChild(chip);
            });

            elements.previewPeriods.appendChild(div);
        });
    }

    function saveCurrentToLocal() {
        const payload = {
            rawData: elements.historyInput.value,
            settings: {
                excludeN: parseInt(elements.excludePeriods.value, 10) || 0,
                predictCount: parseInt(elements.predictCount.value, 10) || 10
            }
        };
        localStorage.setItem(STORAGE_KEY_CURRENT, JSON.stringify(payload));
    }

    function loadCurrentFromLocal() {
        const raw = localStorage.getItem(STORAGE_KEY_CURRENT) || localStorage.getItem(STORAGE_KEY_CURRENT_LEGACY);
        if (!raw) return;

        try {
            const data = JSON.parse(raw);
            elements.historyInput.value = data.rawData || '';
            if (data.settings) {
                elements.excludePeriods.value = data.settings.excludeN ?? 7;
                elements.predictCount.value = data.settings.predictCount ?? 10;
            }
        } catch (e) {
            console.error('Failed to load saved current data', e);
        }
    }

    function loadHistoryFromLocal() {
        const raw = localStorage.getItem(STORAGE_KEY_HISTORY);
        if (!raw) return [];
        try {
            const list = JSON.parse(raw);
            return Array.isArray(list) ? list : [];
        } catch {
            return [];
        }
    }

    function saveHistoryToLocal(list) {
        localStorage.setItem(STORAGE_KEY_HISTORY, JSON.stringify(list));
    }

    function addHistoryEntry(entry) {
        const list = loadHistoryFromLocal();

        const key = `${entry.hash}:${entry.settings.excludeN}:${entry.settings.predictCount}`;
        const existingIdx = list.findIndex(e => `${e.hash}:${e.settings.excludeN}:${e.settings.predictCount}` === key);
        if (existingIdx !== -1) {
            list.splice(existingIdx, 1);
        }

        list.unshift(entry);
        const trimmed = list.slice(0, HISTORY_LIMIT);
        saveHistoryToLocal(trimmed);
        state.history = trimmed;
    }

    function renderHistory() {
        const list = loadHistoryFromLocal();
        state.history = list;
        elements.historyCount.textContent = list.length.toString();

        elements.historyTableBody.innerHTML = '';
        list.forEach(item => {
            const tr = document.createElement('tr');
            const topList = (item.predictions || []).map(pad2).join(' ');

            const btnLoad = `<button class="btn btn-primary btn-sm" data-action="load" data-id="${item.id}">åŠ è½½</button>`;
            const btnDelete = `<button class="btn btn-secondary btn-sm" data-action="delete" data-id="${item.id}">åˆ é™¤</button>`;

            tr.innerHTML = `
                <td>${new Date(item.timestamp).toLocaleString()}</td>
                <td>${item.summary.totalPeriods}</td>
                <td>${item.settings.excludeN}</td>
                <td>${item.settings.predictCount}</td>
                <td>${item.summary.excludedCount}</td>
                <td style="font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;">${topList}</td>
                <td>${btnLoad} ${btnDelete}</td>
            `;
            elements.historyTableBody.appendChild(tr);
        });
    }

    function performAnalysis() {
        const start = performance.now();
        const input = elements.historyInput.value.trim();

        if (!input) {
            showError('è¯·è¾“å…¥å†å²æ•°æ®åå†åˆ†æã€‚');
            return;
        }

        const { periods, allNumbers, diagnostics } = parseInputWithDiagnostics(input);
        state.diagnostics = diagnostics;

        if (periods.length === 0 || allNumbers.length === 0) {
            showError('æœªè¯†åˆ«åˆ°æœ‰æ•ˆçš„ 1-49 æ•°å­—ï¼Œè¯·æ£€æŸ¥æ ¼å¼ã€‚');
            return;
        }

        state.rawData = input;
        state.processedData = periods;
        state.flatData = allNumbers;

        state.settings.excludeN = parseInt(elements.excludePeriods.value, 10) || 0;
        state.settings.predictCount = parseInt(elements.predictCount.value, 10) || 10;

        const excluded = getExcludedNumbers(periods, state.settings.excludeN);
        state.excludedNumbers = excluded;

        const { stats, expectedAvgCount } = calculateStats(periods, allNumbers);
        state.stats = stats;

        const excludedSet = new Set(excluded);
        const predictions = Object.values(stats)
            .filter(s => !excludedSet.has(s.num))
            .sort((a, b) => b.totalScore - a.totalScore)
            .slice(0, state.settings.predictCount);

        state.predictions = predictions;
        state.algorithmResults = buildAlgorithmResults(stats, excluded, state.settings.predictCount);

        saveCurrentToLocal();

        // save to history
        const hash = simpleHash(input);
        addHistoryEntry({
            id: `${Date.now()}_${Math.random().toString(16).slice(2)}`,
            timestamp: new Date().toISOString(),
            hash,
            rawData: input,
            settings: { ...state.settings },
            summary: {
                totalPeriods: periods.length,
                totalNumbers: allNumbers.length,
                excludedCount: excluded.length,
                expectedAvgCount
            },
            predictions: predictions.map(p => p.num),
            excludedNumbers: excluded
        });

        const end = performance.now();
        renderResults(end - start);
        renderHistory();
    }

    function renderResults(costMs) {
        elements.welcomeMessage.classList.add('hidden');
        elements.resultsContainer.classList.remove('hidden');
        elements.detailsContainer.classList.remove('hidden');

        elements.statTotalPeriods.textContent = state.processedData.length.toString();
        elements.statTotalNumbers.textContent = state.flatData.length.toString();
        elements.statExcludedCount.textContent = state.excludedNumbers.length.toString();

        const avgCount = state.flatData.length / 49;
        elements.statAvgCount.textContent = avgCount.toFixed(2);

        elements.analysisTime.textContent = `è€—æ—¶ ${(costMs).toFixed(0)}ms / ${new Date().toLocaleTimeString()}`;
        elements.displayExcludeN.textContent = state.settings.excludeN.toString();
        elements.displayPredictK.textContent = state.settings.predictCount.toString();
        elements.displayPredictK2.textContent = state.settings.predictCount.toString();

        // excluded list
        elements.excludedList.innerHTML = '';
        if (state.excludedNumbers.length === 0) {
            elements.excludedList.textContent = 'æ— ï¼ˆæœªè®¾ç½®é¿å¼€æœŸæ•°æˆ–æ•°æ®ä¸è¶³ï¼‰';
        } else {
            state.excludedNumbers.forEach(n => {
                const span = document.createElement('span');
                span.className = 'badge badge-secondary';
                span.textContent = pad2(n);
                elements.excludedList.appendChild(span);
            });
        }

        // top cards
        elements.topResults.innerHTML = '';
        state.predictions.forEach((p, idx) => {
            const card = document.createElement('div');
            card.className = 'prediction-card';

            let levelClass = 'badge-info';
            let levelText = 'ğŸ”µ å‚è€ƒ';
            if (idx < 3) {
                levelClass = 'badge-success';
                levelText = 'ğŸŸ¢ å¼ºçƒˆæ¨è';
            } else if (idx < 6) {
                levelClass = 'badge-warning';
                levelText = 'ğŸŸ¡ ä¸­ç­‰æ¨è';
            }

            const reasons = [];
            if (p.scores.freq >= 80) reasons.push('å†å²é«˜é¢‘');
            if (p.scores.gap >= 80) reasons.push('å†·å·åå¼¹');
            if (p.scores.period >= 80) reasons.push('å‘¨æœŸåˆ°ç‚¹');
            if (p.scores.chi >= 80) reasons.push('å¡æ–¹åå·®');
            const reasonText = reasons.length ? reasons.join('ã€') : 'ç»¼åˆå¤šé¡¹æŒ‡æ ‡';

            card.innerHTML = `
                <div class="rank-badge">${idx + 1}</div>
                <div style="display: flex; justify-content: flex-end;">
                    <span class="badge ${levelClass}">${levelText}</span>
                </div>
                <div class="prediction-number">${pad2(p.num)}</div>
                <div class="prediction-score">ç»¼åˆé¢„æµ‹æŒ‡æ•°ï¼š<strong>${p.totalScore.toFixed(1)}</strong> / 100</div>
                <div style="font-size: 0.75rem; color: var(--gray-500); display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span>é¢‘ç‡ï¼š${p.freq.toFixed(1)}%</span>
                    <span>é—æ¼ï¼š${p.lastSeen} æœŸ</span>
                </div>
                <div style="font-size: 0.75rem; color: var(--gray-500); display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.25rem;">
                    <span>é¢‘ç‡åˆ†ï¼š${p.scores.freq.toFixed(0)}</span>
                    <span>å†·å·åˆ†ï¼š${p.scores.gap.toFixed(0)}</span>
                    <span>å‘¨æœŸåˆ†ï¼š${p.scores.period.toFixed(0)}</span>
                    <span>å¡æ–¹åˆ†ï¼š${p.scores.chi.toFixed(0)}</span>
                </div>
                <div class="prediction-reason"><strong>åŸå› ï¼š</strong>${reasonText}</div>
            `;

            elements.topResults.appendChild(card);
        });

        renderHeatmap();
        renderFrequencyExtremes();
        renderStatsTable();
        renderChart();
        renderAlgorithmCompare();
    }

    function renderHeatmap() {
        elements.heatmapGrid.innerHTML = '';
        const statsValues = Object.values(state.stats);
        const maxCount = Math.max(...statsValues.map(s => s.count), 0);
        const excludedSet = new Set(state.excludedNumbers);
        const predictedSet = new Set(state.predictions.map(p => p.num));

        for (let i = 1; i <= 49; i++) {
            const s = state.stats[i];
            const cell = document.createElement('div');
            cell.className = 'number-cell';
            cell.textContent = pad2(i);

            const tooltip = document.createElement('div');
            tooltip.className = 'tooltip';
            tooltip.textContent = `å‡ºç° ${s.count} æ¬¡ / é¢‘ç‡ ${s.freq.toFixed(1)}% / é—æ¼ ${s.lastSeen} æœŸ / æœ€ç»ˆåˆ† ${s.totalScore.toFixed(1)}`;
            cell.appendChild(tooltip);

            if (excludedSet.has(i)) {
                cell.classList.add('excluded');
            } else {
                const alpha = maxCount > 0 ? (s.count / maxCount) : 0;
                cell.style.backgroundColor = `rgba(37, 99, 235, ${Math.max(0.05, alpha * 0.8)})`;
                if (alpha > 0.6) cell.style.color = 'white';

                if (s.flags.hot) cell.classList.add('hot');
                if (s.flags.cold) cell.classList.add('cold');

                if (predictedSet.has(i)) {
                    cell.classList.add('predicted');
                    cell.style.backgroundColor = 'var(--white)';
                    cell.style.color = 'var(--gray-900)';
                }
            }

            elements.heatmapGrid.appendChild(cell);
        }
    }

    function renderFrequencyExtremes() {
        const all = Object.values(state.stats);
        const most = [...all].sort((a, b) => b.count - a.count).slice(0, 10);
        const least = [...all].sort((a, b) => a.count - b.count).slice(0, 10);

        function renderList(el, list, tone) {
            el.innerHTML = '';
            list.forEach(item => {
                const b = document.createElement('span');
                b.className = `badge ${tone}`;
                b.textContent = `${pad2(item.num)} (${item.count})`;
                el.appendChild(b);
            });
        }

        renderList(elements.mostFrequentList, most, 'badge-info');
        renderList(elements.leastFrequentList, least, 'badge-secondary');
    }

    function renderStatsTable() {
        elements.statsTableBody.innerHTML = '';

        const excludedSet = new Set(state.excludedNumbers);
        const predictedSet = new Set(state.predictions.map(p => p.num));

        const sorted = Object.values(state.stats).sort((a, b) => b.totalScore - a.totalScore);

        sorted.forEach(s => {
            const tr = document.createElement('tr');
            const isExcluded = excludedSet.has(s.num);
            const isPredicted = predictedSet.has(s.num);

            let status = '<span class="badge badge-secondary">å¸¸è§„</span>';
            if (isExcluded) status = '<span class="badge badge-danger">æ’é™¤</span>';
            else if (isPredicted) status = '<span class="badge badge-success">æ¨é€‰</span>';
            else if (s.flags.hot) status = '<span class="badge badge-warning">çƒ­å·</span>';
            else if (s.flags.cold) status = '<span class="badge badge-info">å†·å·</span>';

            tr.innerHTML = `
                <td style="font-weight: 800;">${pad2(s.num)}</td>
                <td>${s.count}</td>
                <td>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span style="min-width: 50px;">${s.freq.toFixed(1)}%</span>
                        <div class="progress-bar"><div class="progress-fill" style="width: ${clamp(s.freq * 5, 0, 100)}%"></div></div>
                    </div>
                </td>
                <td>${s.lastSeen}</td>
                <td>${s.avgGap.toFixed(1)}</td>
                <td style="color: var(--gray-500); font-size: 0.75rem;">${s.scores.freq.toFixed(0)}</td>
                <td style="color: var(--gray-500); font-size: 0.75rem;">${s.scores.gap.toFixed(0)}</td>
                <td style="color: var(--gray-500); font-size: 0.75rem;">${s.scores.period.toFixed(0)}</td>
                <td style="color: var(--gray-500); font-size: 0.75rem;">${s.scores.comprehensive.toFixed(0)}</td>
                <td style="color: var(--gray-500); font-size: 0.75rem;">${s.scores.chi.toFixed(0)}</td>
                <td style="font-weight: 900; color: var(--primary);">${s.totalScore.toFixed(1)}</td>
                <td>${status}</td>
            `;
            elements.statsTableBody.appendChild(tr);
        });
    }

    function renderChart() {
        elements.topChart.innerHTML = '';
        const maxScore = Math.max(...state.predictions.map(p => p.totalScore), 1);

        state.predictions.forEach(p => {
            const item = document.createElement('div');
            item.className = 'chart-bar-item';
            const height = (p.totalScore / maxScore) * 100;

            item.innerHTML = `
                <div class="chart-bar" style="height: ${height}%">
                    <span class="chart-bar-value">${p.totalScore.toFixed(1)}</span>
                </div>
                <span class="chart-bar-label">#${pad2(p.num)}</span>
            `;
            elements.topChart.appendChild(item);
        });
    }

    function renderAlgorithmCompare() {
        if (!state.algorithmResults) {
            elements.algorithmCompareGrid.innerHTML = '<div class="help-text">è¯·å…ˆåˆ†ææ•°æ®ã€‚</div>';
            return;
        }

        const { freq, gap, period, comprehensive, chi, final } = state.algorithmResults;
        const finalSet = new Set(final);

        const blocks = [
            { key: 'freq', title: 'é¢‘ç‡åˆ†æ Top K', desc: 'å‡ºç°è¶Šå¤šè¶Šå¯èƒ½', list: freq },
            { key: 'gap', title: 'å†·å·åå¼¹ Top K', desc: 'é—æ¼è¶Šä¹…è¶Šå¯èƒ½', list: gap },
            { key: 'period', title: 'æ—¶é—´é—´éš” Top K', desc: 'æ¥è¿‘å¹³å‡é—´éš”æ›´å¯èƒ½', list: period },
            { key: 'comprehensive', title: 'ç»¼åˆè¯„åˆ† Top K', desc: 'é¢‘ç‡/å†·å·/å‘¨æœŸåŠ æƒ', list: comprehensive },
            { key: 'chi', title: 'å¡æ–¹åå·® Top K', desc: 'åç¦»å‡åŒ€åˆ†å¸ƒæ›´æ˜æ˜¾', list: chi },
            { key: 'final', title: 'æœ€ç»ˆæ¨è Top K', desc: 'ç»¼åˆåˆ† + å¡æ–¹åŠ æƒ', list: final }
        ];

        elements.algorithmCompareGrid.innerHTML = '';
        blocks.forEach(b => {
            const div = document.createElement('div');
            div.className = 'algo-card';

            const overlap = b.key === 'final' ? b.list.length : b.list.filter(n => finalSet.has(n)).length;

            div.innerHTML = `
                <h5>${b.title}</h5>
                <div style="font-size: 0.8rem; color: var(--gray-600);">${b.desc} Â· ä¸æœ€ç»ˆæ¨èé‡åˆ <strong>${overlap}</strong> / ${state.settings.predictCount}</div>
                <div class="algo-numbers" id="algo-${b.key}"></div>
            `;

            elements.algorithmCompareGrid.appendChild(div);

            const listEl = div.querySelector(`#algo-${b.key}`);
            b.list.forEach(n => {
                const chip = document.createElement('span');
                chip.className = finalSet.has(n) ? 'badge badge-success' : 'badge badge-secondary';
                chip.textContent = pad2(n);
                listEl.appendChild(chip);
            });
        });
    }

    function exportJSON() {
        if (!state.stats || Object.keys(state.stats).length === 0) {
            showError('è¯·å…ˆå®Œæˆä¸€æ¬¡åˆ†æï¼Œå†å¯¼å‡ºã€‚');
            return;
        }

        const payload = {
            timestamp: new Date().toISOString(),
            settings: { ...state.settings },
            diagnostics: state.diagnostics,
            summary: {
                totalPeriods: state.processedData.length,
                totalNumbers: state.flatData.length,
                excludedCount: state.excludedNumbers.length,
                avgCountPerNumber: state.flatData.length / 49
            },
            excludedNumbers: state.excludedNumbers,
            predictions: state.predictions.map(p => ({
                number: p.num,
                finalScore: p.totalScore,
                frequencyPercent: p.freq,
                lastSeenPeriods: p.lastSeen,
                avgGap: p.avgGap,
                scores: p.scores,
                chiSquare: p.chiSquare
            })),
            algorithmResults: state.algorithmResults,
            fullStats: state.stats
        };

        downloadBlob(new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' }), `number_prediction_${Date.now()}.json`);
    }

    function exportCSV() {
        if (!state.stats || Object.keys(state.stats).length === 0) {
            showError('è¯·å…ˆå®Œæˆä¸€æ¬¡åˆ†æï¼Œå†å¯¼å‡ºã€‚');
            return;
        }

        const excludedSet = new Set(state.excludedNumbers);
        const predictedSet = new Set(state.predictions.map(p => p.num));

        let csv = 'Number,Count,FrequencyPercent,LastSeenPeriods,AvgGap,FreqScore,ColdScore,PeriodScore,ComprehensiveScore,ChiScore,FinalScore,ChiSquare,Status\n';

        Object.values(state.stats).forEach(s => {
            let status = 'Normal';
            if (excludedSet.has(s.num)) status = 'Excluded';
            else if (predictedSet.has(s.num)) status = 'Predicted';
            else if (s.flags.hot) status = 'Hot';
            else if (s.flags.cold) status = 'Cold';

            csv += `${s.num},${s.count},${s.freq.toFixed(2)},${s.lastSeen},${s.avgGap.toFixed(2)},${s.scores.freq.toFixed(2)},${s.scores.gap.toFixed(2)},${s.scores.period.toFixed(2)},${s.scores.comprehensive.toFixed(2)},${s.scores.chi.toFixed(2)},${s.totalScore.toFixed(2)},${s.chiSquare.toFixed(6)},${status}\n`;
        });

        downloadBlob(new Blob([csv], { type: 'text/csv' }), `number_prediction_${Date.now()}.csv`);
    }

    function setupTabs() {
        elements.tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                elements.tabs.forEach(t => t.classList.remove('active'));
                elements.tabContents.forEach(c => c.classList.remove('active'));

                tab.classList.add('active');
                const contentId = tab.getAttribute('data-tab');
                document.getElementById(contentId).classList.add('active');

                if (contentId === 'tab-history') {
                    renderHistory();
                }
            });
        });
    }

    function setupHistoryActions() {
        elements.historyTableBody.addEventListener('click', (e) => {
            const btn = e.target.closest('button');
            if (!btn) return;

            const action = btn.getAttribute('data-action');
            const id = btn.getAttribute('data-id');

            const list = loadHistoryFromLocal();
            const idx = list.findIndex(x => x.id === id);
            if (idx === -1) return;

            if (action === 'load') {
                const item = list[idx];
                elements.historyInput.value = item.rawData || elements.historyInput.value;
                elements.excludePeriods.value = item.settings.excludeN;
                elements.predictCount.value = item.settings.predictCount;
                renderPreview();
                performAnalysis();

                // switch to overview
                elements.tabs.forEach(t => t.classList.remove('active'));
                elements.tabContents.forEach(c => c.classList.remove('active'));
                const heatTab = document.querySelector('.tab[data-tab="tab-heatmap"]');
                if (heatTab) heatTab.classList.add('active');
                document.getElementById('tab-heatmap').classList.add('active');
            }

            if (action === 'delete') {
                if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å†å²è®°å½•å—ï¼Ÿ')) return;
                list.splice(idx, 1);
                saveHistoryToLocal(list);
                renderHistory();
            }
        });

        elements.btnClearHistory.addEventListener('click', () => {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºå…¨éƒ¨å†å²è®°å½•å—ï¼Ÿ')) return;
            localStorage.removeItem(STORAGE_KEY_HISTORY);
            renderHistory();
        });
    }

    function attachEvents() {
        elements.btnAnalyze.addEventListener('click', performAnalysis);

        elements.btnClear.addEventListener('click', () => {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºè¾“å…¥æ¡†å’Œåˆ†æç»“æœå—ï¼Ÿ')) return;
            elements.historyInput.value = '';
            localStorage.removeItem(STORAGE_KEY_CURRENT);
            localStorage.removeItem(STORAGE_KEY_CURRENT_LEGACY);
            clearError();
            elements.inputWarning.classList.add('hidden');
            elements.resultsContainer.classList.add('hidden');
            elements.detailsContainer.classList.add('hidden');
            elements.welcomeMessage.classList.remove('hidden');
            renderPreview();
        });

        elements.btnLoadExample.addEventListener('click', () => {
            const examples = [];
            // pseudo-random, each line as one period with 7 unique numbers
            for (let i = 0; i < 20; i++) {
                const period = new Set();
                while (period.size < 7) {
                    period.add(Math.floor(Math.random() * 49) + 1);
                }
                examples.push(Array.from(period).sort((a, b) => a - b).join(' '));
            }
            elements.historyInput.value = examples.join('\n');
            renderPreview();
        });

        elements.historyInput.addEventListener('input', debounce(() => {
            renderPreview();
            saveCurrentToLocal();
        }, 200));

        elements.excludePeriods.addEventListener('input', debounce(() => {
            saveCurrentToLocal();
        }, 200));

        elements.predictCount.addEventListener('input', debounce(() => {
            saveCurrentToLocal();
        }, 200));

        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'Enter') {
                performAnalysis();
            }
        });

        elements.btnExportJSON.addEventListener('click', exportJSON);
        elements.btnExportCSV.addEventListener('click', exportCSV);
    }

    // Initial
    loadCurrentFromLocal();
    renderPreview();
    setupTabs();
    attachEvents();
    setupHistoryActions();
    renderHistory();

    // If there is existing data, run analysis once
    if (elements.historyInput.value.trim()) {
        performAnalysis();
    }
</script>

</body>
</html>
